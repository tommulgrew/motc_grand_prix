#title Mot Grand Prix
#include "library/trig"
#include "assets"
#include "tracks"
#include "models"
#include "trackdata"
#include "gameplay"
#include "world"
#include "rendergame"

Track[] tracks = new Track[0];

// Deserialize tracks
for (int i = 0; i < trackData.length; i++) {
	Track track = loadTrack(
		new Stream { data = trackData[i] },
		trackNames[i],
		trackFinishlineDistances[i]);
	tracks.add(track);
}

// Setup for race
Track currentTrack = tracks[2];
initRace(currentTrack);

screen(makeimg(SCREEN_WIDTH, SCREEN_HEIGHT));

// Main loop
while (true) {
	drawGame(currentTrack);
	print(player.pos.z, 1, 1);
	flip();
	interval(1000 / 30);

	float speed = keydn(KEY_LSHIFT) ? 0.5 : 0.1;
	if (keydn(KEY_UP)) 		player.pos += new Vec { z = speed };
	if (keydn(KEY_DOWN))	player.pos -= new Vec { z = speed };
	player.pos.z = max(player.pos.z, 0);
	int segi = floor(player.pos.z);
	WorldSegment seg = world[segi % world.length];
	WorldSegment nextSeg = world[(segi + 1) % world.length];
	float zOffset = player.pos.z - floor(player.pos.z);
	player.turn = lerp(0, seg.turn, zOffset);
	player.pitch = lerp(seg.pitch, nextSeg.pitch, zOffset);
}
