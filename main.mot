#title Mot Grand Prix
#executable motgp
#webtemplate driving
#file assets/textures.png
#file assets/sfx/getready.wav
#file assets/sfx/go.wav
#file assets/sfx/lapbell.wav
#file assets/sfx/crash1.wav
#file assets/sfx/crash2.wav
#file assets/sfx/crash3.wav
#file assets/sfx/groundslide.wav
#file assets/sfx/roadslide.wav
#file assets/sfx/engine1.wav
#file assets/sfx/engine2.wav

#include "library/trig"
#include "assets"
#include "tracks"
#include "models"
#include "gameconfig"
#include "gameplay"
#include "world"
#include "rendergame"
#include "menu"
#include "app"

// Routines

void draw();
void update();

UIInput uiInput = new UIInput {
	btnDown = new bool[9],        
	btnPressed = new bool[9]
};

// Setup screen buffer
screen(makeimg(SCREEN_WIDTH, SCREEN_HEIGHT));

// Start in menu mode
setGameMode(GAMEMODE_MENU);

// Main loop
while (true) {
	if (interval(1000 / 30, 3)) {
		update();
		frame++;	
	}
	else {
		draw();

		// color(7);
		// print("GC:       " + stat(MEMORY_GCCOUNT), 1, 50); print("");
		// print("GC Full:  " + stat(MEMORY_FULLGCCOUNT));
		// print("Heap used:" + stat(MEMORY_LASTGCHEAPUSED) + " " + ((stat(MEMORY_LASTGCHEAPUSED) * 100) / stat(MEMORY_HEAPSIZE)) + "%");

		flip();
	}
}

void setGameMode(int mode) {
	if (gameMode != mode) {
		gameMode = mode;
		if (gameMode = GAMEMODE_MENU) initMenu();
		else if (gameMode = GAMEMODE_RACE) initRace();
		else assert(false, "Unknown game mode");
	}
}

void draw() {
	if (gameMode = GAMEMODE_MENU) drawMenu();
	else if (gameMode = GAMEMODE_RACE) drawGame();
}

void update() {
	updateUIInput(uiInput);
	if (gameMode = GAMEMODE_MENU) updateMenu(uiInput);
	else if (gameMode = GAMEMODE_RACE) updateGame();
}
